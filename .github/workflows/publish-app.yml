name: Publish App Images

on:
  release:
    types: [published]
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 0.1.0 or v0.1.0)"
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Resolve version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            raw="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            raw="${{ github.ref_name }}"
          else
            raw="${{ inputs.version }}"
          fi
          version="${raw#v}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Validate config version
        shell: bash
        run: |
          config_version="$(sed -n 's/^version:[[:space:]]*"\{0,1\}\([^"]*\)"\{0,1\}$/\1/p' apps/hass_flatmate_service/config.yaml)"
          if [ -z "$config_version" ]; then
            echo "Unable to read apps/hass_flatmate_service/config.yaml version"
            exit 1
          fi
          if [ "$config_version" != "${{ steps.version.outputs.version }}" ]; then
            echo "Release version mismatch: config=$config_version, requested=${{ steps.version.outputs.version }}"
            exit 1
          fi

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Home Assistant app images
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --amd64 \
            --aarch64 \
            --target ./apps/hass_flatmate_service \
            --image ghcr.io/gitviola/hass-flatmate-service-{arch} \
            --version ${{ steps.version.outputs.version }}

      - name: Attempt to set package visibility public
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for pkg in \
            hass-flatmate-service-amd64 \
            hass-flatmate-service-aarch64 \
            ghcr.io/gitviola/hass-flatmate-service-amd64 \
            ghcr.io/gitviola/hass-flatmate-service-aarch64
          do
            encoded_pkg="$(printf '%s' "$pkg" | jq -sRr @uri)"
            gh api --method PATCH \
              -H "Accept: application/vnd.github+json" \
              "/user/packages/container/${encoded_pkg}/visibility" \
              -f visibility=public || true
          done

      - name: Verify anonymous pull works for both architectures
        shell: bash
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          for arch in amd64 aarch64; do
            image="ghcr.io/gitviola/ghcr.io/gitviola/hass-flatmate-service-${arch}"
            repo="${image#ghcr.io/}"
            token="$(curl -sS "https://ghcr.io/token?service=ghcr.io&scope=repository:${repo}:pull" | jq -r '.token')"
            if [ -z "$token" ] || [ "$token" = "null" ]; then
              echo "Could not obtain anonymous GHCR token for ${repo}"
              exit 1
            fi
            status="$(curl -sS -o /tmp/manifest.json -w '%{http_code}' \
              -H "Authorization: Bearer ${token}" \
              -H 'Accept: application/vnd.oci.image.manifest.v1+json, application/vnd.docker.distribution.manifest.v2+json' \
              "https://ghcr.io/v2/${repo}/manifests/${version}")"
            if [ "$status" != "200" ]; then
              echo "Anonymous pull check failed for ${image}:${version} (HTTP ${status})"
              cat /tmp/manifest.json
              exit 1
            fi
          done
