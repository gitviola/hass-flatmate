name: Publish App Images

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 0.1.0 or v0.1.0)"
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Resolve version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            raw="${{ github.event.release.tag_name }}"
          else
            raw="${{ inputs.version }}"
          fi
          version="${raw#v}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Validate config version
        shell: bash
        run: |
          config_version="$(sed -n 's/^version:[[:space:]]*"\{0,1\}\([^"]*\)"\{0,1\}$/\1/p' apps/hass_flatmate_service/config.yaml)"
          if [ -z "$config_version" ]; then
            echo "Unable to read apps/hass_flatmate_service/config.yaml version"
            exit 1
          fi
          if [ "$config_version" != "${{ steps.version.outputs.version }}" ]; then
            echo "Release version mismatch: config=$config_version, requested=${{ steps.version.outputs.version }}"
            exit 1
          fi

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Home Assistant app images
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --amd64 \
            --aarch64 \
            --target ./apps/hass_flatmate_service \
            --image ghcr.io/ms/hass-flatmate-service-{arch} \
            --version ${{ steps.version.outputs.version }}
